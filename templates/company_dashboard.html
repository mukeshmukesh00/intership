{% extends "base.html" %} 
{% block title %}Company Dashboard{% endblock %} 

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>Company Dashboard</h2>
  <a href="{{ url_for('company.post_internship') }}" class="btn btn-primary"
    >Post New Internship</a
  >
</div>

<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0">My Internships</h5>
  </div>
  <div class="card-body">
    {% if internships %}
    <div class="row">
      {% for internship in internships %}
      <div class="col-md-6 mb-3">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">{{ internship['title'] }}</h5>
            <p class="card-text">
              {{ internship['description']|truncate(100) }}
            </p>
            <p>
              <strong>Required Skills:</strong> {{ internship['required_skills']
              }}
            </p>
            <p class="text-muted mb-0">
              <small><i class="far fa-calendar"></i> Posted: {{ internship['posted_at'] }}</small>
            </p>
          </div>
          <div class="card-footer">
            <div class="d-flex justify-content-between">
              <button 
                type="button"
                class="btn btn-sm btn-outline-primary view-details" 
                data-internship-id="{{ internship['id'] }}"
                data-internship-title="{{ internship['title'] }}"
                data-internship-description="{{ internship['description'] }}"
                data-internship-skills="{{ internship['required_skills'] }}"
                data-internship-posted="{{ internship['posted_at'] }}"
              >
                <i class="fas fa-eye me-1"></i>View Details
              </button>
              <button 
                type="button"
                class="btn btn-sm btn-outline-danger delete-internship" 
                data-internship-id="{{ internship['id'] }}"
                data-internship-title="{{ internship['title'] }}"
                title="Delete this internship"
              >
                <i class="fas fa-trash me-1"></i>Delete
              </button>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p>You haven't posted any internships yet.</p>
    <a href="{{ url_for('company.post_internship') }}" class="btn btn-primary"
      >Post Your First Internship</a
    >
    {% endif %}
  </div>
</div>

<!-- Applications -->
<div class="card mb-4">
  <div class="card-header bg-info text-white">
    <h5 class="mb-0">Applications</h5>
  </div>
  <div class="card-body">
    {% if applications %}
    <div class="accordion" id="applicationsAccordion">
      {% for internship in internships %} {% if applications[internship['id']]
      %}
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading{{ internship['id'] }}">
          <button
            class="accordion-button"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapse{{ internship['id'] }}"
            aria-expanded="true"
            aria-controls="collapse{{ internship['id'] }}"
          >
            {{ internship['title'] }} ({{ applications[internship['id']]|length
            }} applications)
          </button>
        </h2>
        <div
          id="collapse{{ internship['id'] }}"
          class="accordion-collapse collapse show"
          aria-labelledby="heading{{ internship['id'] }}"
          data-bs-parent="#applicationsAccordion"
        >
          <div class="accordion-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Student</th>
                    <th>Applied At</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for app in applications[internship['id']] %}
                  <tr>
                    <td>{{ app['student_name'] }}</td>
                    <td>{{ app['applied_at'] }}</td>
                    <td>
                      <span
                        class="badge {% if app['status'] == 'accepted' %}bg-success {% elif app['status'] == 'rejected' %}bg-danger {% else %}bg-warning text-dark{% endif %}"
                      >
                        {{ app['status']|capitalize }}
                      </span>
                    </td>
                    <td>
                      <div class="btn-group">
                        <button
                          class="btn btn-sm btn-outline-primary update-status"
                          data-app-id="{{ app['id'] }}"
                          data-status="accepted"
                        >
                          Accept
                        </button>
                        <button
                          class="btn btn-sm btn-outline-danger update-status"
                          data-app-id="{{ app['id'] }}"
                          data-status="rejected"
                        >
                          Reject
                        </button>
                        <a
                          href="/company/view-cv/{{ app['student_id'] }}"
                          class="btn btn-sm btn-outline-success"
                          target="_blank"
                        >
                          View CV
                        </a>
                        <button
                          class="btn btn-sm btn-outline-info send-message"
                          data-student-id="{{ app['student_id'] }}"
                          data-internship-id="{{ internship['id'] }}"
                        >
                          Message
                        </button>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      {% endif %} {% endfor %}
    </div>
    {% else %}
    <p>No applications received yet.</p>
    {% endif %}
  </div>
</div>

<!-- Message Modal -->
<div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Send Message to Applicant</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="messageForm">
          <input type="hidden" id="receiverId" name="receiver_id" />
          <input type="hidden" id="internshipId" name="internship_id" />
          <div class="mb-3">
            <label for="messageContent" class="form-label">Message</label>
            <textarea
              class="form-control"
              id="messageContent"
              name="content"
              rows="4"
              required
            ></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Send Message</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Internship Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="detailsModalLabel">
          <i class="fas fa-briefcase me-2"></i><span id="detailsTitle"></span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <h6 class="text-primary"><i class="fas fa-align-left me-2"></i>Description</h6>
          <p id="detailsDescription" class="ms-4"></p>
        </div>
        <div class="mb-3">
          <h6 class="text-primary"><i class="fas fa-tools me-2"></i>Required Skills</h6>
          <div id="detailsSkills" class="ms-4"></div>
        </div>
        <div class="mb-3">
          <h6 class="text-primary"><i class="far fa-calendar-alt me-2"></i>Posted Date</h6>
          <p id="detailsPosted" class="ms-4"></p>
        </div>
        <div class="mb-3">
          <h6 class="text-primary"><i class="fas fa-users me-2"></i>Applications</h6>
          <p id="detailsApplications" class="ms-4">Loading...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Delete Internship</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the internship <strong id="internshipTitle"></strong>?</p>
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Warning:</strong> This action will permanently delete:
          <ul class="mb-0 mt-2">
            <li>The internship posting</li>
            <li>All applications for this internship</li>
            <li>All related messages</li>
          </ul>
        </div>
        <p class="text-danger"><strong>This action cannot be undone.</strong></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDelete">
          <i class="fas fa-trash me-1"></i> Delete Internship
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  $(document).ready(function () {
    console.log("Company dashboard JavaScript loaded!");
    console.log("jQuery version:", $.fn.jquery);
    console.log("Bootstrap version:", typeof bootstrap !== 'undefined' ? 'loaded' : 'not loaded');
    
    // View internship details
    $(".view-details").click(function () {
      const internshipId = $(this).data("internship-id");
      const title = $(this).data("internship-title");
      const description = $(this).data("internship-description");
      const skills = $(this).data("internship-skills");
      const posted = $(this).data("internship-posted");
      
      // Set modal content
      $("#detailsTitle").text(title);
      $("#detailsDescription").text(description);
      $("#detailsPosted").text(posted);
      
      // Display skills as badges
      const skillsArray = skills.split(',');
      let skillsHtml = '';
      skillsArray.forEach(function(skill) {
        skillsHtml += `<span class="badge bg-secondary me-2 mb-2">${skill.trim()}</span>`;
      });
      $("#detailsSkills").html(skillsHtml);
      
      // Count applications for this internship
      let appCount = 0;
      {% if applications %}
      const applications = {{ applications|tojson }};
      if (applications[internshipId]) {
        appCount = applications[internshipId].length;
      }
      {% endif %}
      
      $("#detailsApplications").html(`
        <span class="badge bg-info">${appCount}</span> 
        ${appCount === 1 ? 'application received' : 'applications received'}
      `);
      
      // Show modal using Bootstrap 5
      const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
      detailsModal.show();
    });
    
    // Update application status
    $(".update-status").click(function () {
      const appId = $(this).data("app-id");
      const status = $(this).data("status");

      $.ajax({
        url: `/company/application/${appId}/update`,
        method: "POST",
        data: { status: status },
        success: function (response) {
          if (response.success) {
            location.reload();
          } else {
            alert("Error: " + response.message);
          }
        },
        error: function () {
          alert("An error occurred. Please try again.");
        },
      });
    });

    // Open message modal
    $(".send-message").click(function () {
      const studentId = $(this).data("student-id");
      const internshipId = $(this).data("internship-id");

      $("#receiverId").val(studentId);
      $("#internshipId").val(internshipId);
      
      // Show modal using Bootstrap 5
      const messageModal = new bootstrap.Modal(document.getElementById('messageModal'));
      messageModal.show();
    });

    // Send message
    $("#messageForm").submit(function (e) {
      e.preventDefault();

      $.ajax({
        url: "/message/send",
        method: "POST",
        data: $(this).serialize(),
        success: function (response) {
          if (response.success) {
            const messageModal = bootstrap.Modal.getInstance(document.getElementById('messageModal'));
            messageModal.hide();
            showStatusMessage("Message sent successfully!", "success");
            $("#messageForm")[0].reset();
          } else {
            showStatusMessage("Error: " + response.message, "error");
          }
        },
        error: function () {
          showStatusMessage("An error occurred. Please try again.", "error");
        },
      });
    });
    
    // Delete internship functionality
    let internshipToDelete = null;
    
    $(".delete-internship").click(function () {
      console.log("Delete button clicked!");
      const internshipId = $(this).data("internship-id");
      const internshipTitle = $(this).data("internship-title");
      
      console.log("Internship ID:", internshipId);
      console.log("Internship Title:", internshipTitle);
      
      internshipToDelete = internshipId;
      $("#internshipTitle").text(internshipTitle);
      
      // Show modal using Bootstrap 5
      const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
      deleteModal.show();
    });
    
    $("#confirmDelete").click(function () {
      console.log("Confirm delete clicked!");
      console.log("Internship to delete:", internshipToDelete);
      
      if (internshipToDelete) {
        const button = $(this);
        const originalText = button.html();
        
        console.log("Sending delete request for internship:", internshipToDelete);
        
        // Show loading state
        button.prop('disabled', true);
        button.html('<i class="fas fa-spinner fa-spin me-1"></i>Deleting...');
        
        $.ajax({
          url: `/company/internship/${internshipToDelete}/delete`,
          method: "POST",
          success: function (response) {
            console.log("Delete response:", response);
            if (response.success) {
              const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
              deleteModal.hide();
              showStatusMessage('Internship deleted successfully!', 'success');
              
              // Reload page after a short delay
              setTimeout(function() {
                location.reload();
              }, 1000);
            } else {
              showStatusMessage('Error: ' + response.message, 'error');
              button.prop('disabled', false);
              button.html(originalText);
            }
          },
          error: function (xhr, status, error) {
            console.log("Delete error:", error);
            console.log("Status:", status);
            console.log("Response:", xhr.responseText);
            showStatusMessage('An error occurred. Please try again.', 'error');
            button.prop('disabled', false);
            button.html(originalText);
          },
        });
      } else {
        console.log("No internship selected for deletion");
      }
    });
    
    // Function to show status messages
    function showStatusMessage(message, type) {
      const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
      const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
          <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `;
      $('body').append(alertHtml);
      
      // Auto-dismiss after 3 seconds
      setTimeout(function() {
        $('.alert').fadeOut();
      }, 3000);
    }
  });
</script>
{% endblock %}
